--changelog
--cambie el tipo de dato id profesor por string Tabla Profesor prestamo
--Cree un index para la tabla prestamos en forma decendente
--inserte mas salones
--modifique valores default de ev_horasservicio
CREATE TABLE E_DEPARTAMENTOS(
ID_DEPARTAMENTO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(40),
ABBREV VARCHAR(15),
ENCARGADO VARCHAR(50),
CREADO DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
ACTUALIZADO DATETIME DEFAULT CURRENT_TIMESTAMP);

CREATE TABLE E_PROFESORES(
ID_PROFESOR BIGINT NOT NULL PRIMARY KEY,
ID_DEPARTAMENTO INT NOT NULL ,
NOMBRE VARCHAR(25) NOT NULL,
A_PATERNO VARCHAR(25) NOT NULL,
A_MATERNO VARCHAR(25),
ESTATUS_ESCOLAR BOOLEAN DEFAULT TRUE, --UN ESTADO FALSE INDICA HONORARIOS, TRUE INDICA PLAZA
ESTATUS BOOLEAN DEFAULT TRUE,
CREADO DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
ACTUALIZADO DATETIME DEFAULT CURRENT_TIMESTAMP);

CREATE TABLE E_AULAS(
ID_AULA INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(25) NOT NULL,
ESTATUS BOOLEAN DEFAULT TRUE,
CREADO DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
ACTUALIZADO DATETIME DEFAULT CURRENT_TIMESTAMP);

CREATE TABLE E_USUARIOS(
ID_USUARIO VARCHAR(15) NOT NULL PRIMARY KEY,
NOMBRE VARCHAR(25) NOT NULL,
A_PATERNO VARCHAR(15) NOT NULL,
A_MATERNO VARCHAR(15),
PASSWORD VARCHAR(60) NOT NULL,
ADMINDR BOOLEAN DEFAULT FALSE,
CREADO DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
ACTUALIZADO DATETIME DEFAULT CURRENT_TIMESTAMP);

CREATE TABLE E_VIDEOPROYECTORES(
ID_VIDEOPROYECTOR INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(15),
MARCA VARCHAR(15),
MODELO VARCHAR(20),
NO_SERIE VARCHAR(20),
CREADO DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
ACTUALIZADO DATETIME DEFAULT CURRENT_TIMESTAMP);

CREATE TABLE E_PRESTAMOS(
ID_PRESTAMO BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
ID_SALIDA VARCHAR(15) NOT NULL,
ID_ENTRADA VARCHAR(15),
ID_VIDEOPROYECTOR INT NOT NULL,
ID_PROFESOR BIGINT NOT NULL,
ID_AULA INT NOT NULL,
ESTATUS BOOLEAN DEFAULT TRUE,
CREADO DATETIME DEFAULT CURRENT_TIMESTAMP,
ACTUALIZADO DATETIME DEFAULT CURRENT_TIMESTAMP);

CREATE TABLE EVR_AVERIAS(
ID_AVERIA INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
ID_VIDEOPROYECTOR INT NOT NULL,
ID_REPORTE INT NOT NULL,
DESCRIPCION CLOB,
CREADO DATETIME DEFAULT CURRENT_TIMESTAMP,
ACTUALIZADO DATETIME DEFAULT CURRENT_TIMESTAMP);

CREATE TABLE EVR_REPORTES(
ID_REPORTE INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
TITULO VARCHAR(30),
DETALLES CLOB,
POSIBLE_SOLUCION CLOB,
CREADO DATETIME DEFAULT CURRENT_TIMESTAMP,
ACTUALIZADO DATETIME DEFAULT CURRENT_TIMESTAMP);

CREATE TABLE EV_ACCESORIOS(
ID_ACCESORIO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
ID_VIDEOPROYECTOR INT NOT NULL,
NOMBRE VARCHAR(20));

CREATE TABLE EV_HORASSERVICIO(
ID_HORAS_SERVICIO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
ID_VIDEOPROYECTOR INT NOT NULL,
TOTAL INT,
MES INT,
SEMESTRE INT);

CREATE TABLE EV_ESTATUS(
ID_ESTATUS INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
ID_VIDEOPROYECTOR INT NOT NULL,
NOMBRE VARCHAR(15),
DISPONIBILIDAD BOOLEAN DEFAULT TRUE);



/* FOREIGN KEYS */

  ALTER TABLE E_PROFESORES
  ADD CONSTRAINT PROFESORES_FK_DEPARTAMENTO
  FOREIGN KEY (ID_DEPARTAMENTO) REFERENCES E_DEPARTAMENTOS(ID_DEPARTAMENTO)
  ON DELETE CASCADE
  ON UPDATE CASCADE;

  ALTER TABLE E_PRESTAMOS
  ADD CONSTRAINT PRESTAMOS_FK_USUARIO_REGISTRA_SALIDA
  FOREIGN KEY (ID_SALIDA) REFERENCES E_USUARIOS(ID_USUARIO);

  ALTER TABLE E_PRESTAMOS
  ADD CONSTRAINT PRESTAMOS_FK_USUARIO_REGISTRA_ENTRADA
  FOREIGN KEY (ID_ENTRADA) REFERENCES E_USUARIOS(ID_USUARIO);

  ALTER TABLE E_PRESTAMOS
  ADD CONSTRAINT PRESTAMOS_FK_VIDEOPROYECTOR
  FOREIGN KEY (ID_VIDEOPROYECTOR)
  REFERENCES E_VIDEOPROYECTORES(ID_VIDEOPROYECTOR);

  ALTER TABLE E_PRESTAMOS
  ADD CONSTRAINT PRESTAMOS_FK_PROFESOR
  FOREIGN KEY (ID_PROFESOR)
  REFERENCES E_PROFESORES(ID_PROFESOR);

  ALTER TABLE E_PRESTAMOS
  ADD CONSTRAINT PRESTAMOS_FK_AULA
  FOREIGN KEY (ID_AULA)
  REFERENCES E_AULAS(ID_AULA);

  ALTER TABLE EVR_AVERIAS
  ADD CONSTRAINT AVERIAS_FK_VIDEOPROYECTOR
  FOREIGN KEY (ID_VIDEOPROYECTOR)
  REFERENCES E_VIDEOPROYECTORES(ID_VIDEOPROYECTOR);

  ALTER TABLE EVR_AVERIAS
  ADD CONSTRAINT AVERIAS_FK_REPORTE
  FOREIGN KEY (ID_REPORTE)
  REFERENCES EVR_REPORTES(ID_REPORTE);

  ALTER TABLE EV_ACCESORIOS
  ADD CONSTRAINT ACCESORIOS_FK_VIDEOPROYECTOR
  FOREIGN KEY (ID_VIDEOPROYECTOR)
  REFERENCES E_VIDEOPROYECTORES(ID_VIDEOPROYECTOR);

  ALTER TABLE EV_HORASSERVICIO
  ADD CONSTRAINT HORASSERVICIO_FK_VIDEOPROYECTOR
  FOREIGN KEY (ID_VIDEOPROYECTOR)
  REFERENCES E_VIDEOPROYECTORES(ID_VIDEOPROYECTOR)
  ON DELETE CASCADE;

  ALTER TABLE EV_ESTATUS
  ADD CONSTRAINT ESTATUS_FK_VIDEOPROYECTOR
  FOREIGN KEY (ID_VIDEOPROYECTOR)
  REFERENCES E_VIDEOPROYECTORES(ID_VIDEOPROYECTOR)
  ON DELETE CASCADE
  ON UPDATE CASCADE;

/*nuevos datos*/
INSERT INTO E_AULAS(NOMBRE) VALUES
('A01'),('A02'),('A03'),('A04'),('A05'),('A06'),('A07'),('A08'),('A09'),('A10'),
('A11'),('A12'),('A13'),('A14'),('A15'),('A16'),('A17'),('A18'),('A19'),('A20'),
('A21'),('A22'),('A23'),('A24'),('A25'),('A26'),('A27'),('A28'),('A29'),('A30'),
('A31'),('A32'),('A33'),('A34'),('A35'),('A36'),('A37');

INSERT INTO E_DEPARTAMENTOS(nombre, abbrev, encargado) VALUES
('Metal-Mecánica', 'M. MEC.', 'Ing. Florez Alonso Alejandro'),
('Ciencias Básicas', 'C. B.', 'Cota Ramírez Anabel'),
('Ciencias de la Tierra', 'C. T.', 'Arq. Torres Ruiz Nydia'),
('Electrica y Elctrónica', 'Elec. Elec.','Ing. Muñiz Elizalde José David'),
('Sistemas y Computación', 'SyC', 'Ing. Amezcua Fierros Claudia'),
('Ciencias Económico-Administrativas', 'CEA', 'Lic. Vázquez Olvera Ernesto'),
('Desarrollo Académico', 'Des. Académico', 'Ing. Pacheco Hernández Raquel');
/*MODIFICACIONES Y DATOS FALTANTES*/
ALTER TABLE E_PROFESORES MODIFY ID_PROFESOR VARCHAR(12);
ALTER TABLE E_PRESTAMOS MODIFY ID_PROFESOR VARCHAR(12);
INSERT INTO E_AULAS(NOMBRE) VALUES
('B01'),('B02'),('B03'),
('C01'),('C02'),('C03'),('C04'),
('D01'),('D02'),('D03'),('D04'),('D05'),('D06'),
('E01'),('E02'),('E03'),('E04'),
('R01'),('R02'),('R03'),('CC1'),('CC2'),('CC3'),
('Lab. de Electrónica'),('Lab. de Mecatrónica'),('Lab. de Química'),
('Lab. de Automotriz'),('Taller de Construcción');
CREATE INDEX REGPREST_TO_DESC ON E_PRESTAMOS(ID_PRESTAMO DESC);
/*DATOS DE PRUEBA
INSERT INTO E_PROFESORES(ID_PROFESOR, ID_DEPARTAMENTO,NOMBRE, A_PATERNO, A_MATERNO) VALUES
(18054300,1, 'ALEJANDRO','ALEJANDRO','FUENTES'),
(18054792,2, 'JOSÉ JOSÉ', 'JOSÉ', 'JOSÉ'),
(18058859,5, 'JOSÉ DOROTEO', 'ARANGO', 'ARÁMBULA');

INSERT INTO E_VIDEOPROYECTORES(NOMBRE, MARCA, MODELO, NO_SERIE) VALUES
('VH12', 'EPSON', 'HSKAW212','125A724'),
('VH13', 'BENQ', 'HSKAW212','LIL1812A'),
('VH14', 'VIEWSONIC', 'IRIS REMAR-K-BLE','EKA7615A'),
('VH15', 'SONY', 'K-BLE','2541E7A'),
('VH16', 'TOSHIBA', 'K-BLE','2541E7E');

INSERT INTO EV_ESTATUS(ID_VIDEOPROYECTOR, NOMBRE) VALUES
((SELECT ID_VIDEOPROYECTOR FROM E_VIDEOPROYECTORES WHERE NO_SERIE = '125A724'), 'DISPONIBLE'),
((SELECT ID_VIDEOPROYECTOR FROM E_VIDEOPROYECTORES WHERE NO_SERIE = 'LIL1812A'), 'DISPONIBLE'),
((SELECT ID_VIDEOPROYECTOR FROM E_VIDEOPROYECTORES WHERE NO_SERIE = 'EKA7615A'), 'DISPONIBLE'),
((SELECT ID_VIDEOPROYECTOR FROM E_VIDEOPROYECTORES WHERE NO_SERIE = '2541E7A'), 'DISPONIBLE'),
((SELECT ID_VIDEOPROYECTOR FROM E_VIDEOPROYECTORES WHERE NO_SERIE = '2541E7E'), 'DISPONIBLE');
*/
/*ARREGLANDO ARTICULOS*/
ALTER TABLE EV_ACCESORIOS ADD COLUMN (EXISTENCIAS INT, DISPONIBLE INT, DESCRIPCION CLOB) AFTER NOMBRE;
ALTER TABLE EV_ACCESORIOS DROP CONSTRAINT ACCESORIOS_FK_VIDEOPROYECTOR;
ALTER TABLE EV_ACCESORIOS DROP COLUMN ID_VIDEOPROYECTOR;
ALTER TABLE EV_ACCESORIOS RENAME TO E_ACCESORIOS;

CREATE TABLE EPV_ACCESORIOS(
ID_EPV_ACCESORIO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
ID_ACCESORIO INT NOT NULL,
ID_PRESTAMO BIGINT NOT NULL,
CREADO DATETIME DEFAULT CURRENT_TIMESTAMP);

ALTER TABLE EPV_ACCESORIOS
ADD CONSTRAINT ACCESORIOS_FK_EPVACC
FOREIGN KEY (ID_ACCESORIO)
REFERENCES E_ACCESORIOS(ID_ACCESORIO)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE EPV_ACCESORIOS
ADD CONSTRAINT PRESTAMO_FK_EPVACC
FOREIGN KEY (ID_PRESTAMO)
REFERENCES E_PRESTAMOS(ID_PRESTAMO)
ON DELETE CASCADE
ON UPDATE CASCADE;
/*AREGLANDO HORAS SERVICIO*/
ALTER TABLE EV_HORASSERVICIO ALTER COLUMN TOTAL SET DEFAULT 0;
ALTER TABLE EV_HORASSERVICIO ALTER COLUMN MES SET DEFAULT 0;
ALTER TABLE EV_HORASSERVICIO ALTER COLUMN SEMESTRE SET DEFAULT  0;
/*insertar los proyectores creados la tabla ev_horasservicio con 0 hrs registradas*/
/*
INSERT INTO EV_HORASSERVICIO(ID_VIDEOPROYECTOR) SELECT ID_VIDEOPROYECTOR  FROM E_VIDEOPROYECTORES;
UPDATE EV_HORASSERVICIO 
SET TOTAL = SELECT SUM(DATEDIFF('MI', CREADO, ACTUALIZADO)) 
                      FROM E_PRESTAMOS 
                      WHERE  EV_HORASSERVICIO.ID_VIDEOPROYECTOR = E_PRESTAMOS.ID_VIDEOPROYECTOR

UPDATE EV_HORASSERVICIO 
SET MES = SELECT SUM(DATEDIFF('MI', CREADO, ACTUALIZADO)) 
	FROM E_PRESTAMOS 
	WHERE EV_HORASSERVICIO.ID_VIDEOPROYECTOR = E_PRESTAMOS .ID_VIDEOPROYECTOR 
	AND 
	CREADO BETWEEN 
		CONCAT(EXTRACT(YEAR FROM CURRENT_TIMESTAMP()),'-', EXTRACT(MONTH FROM CURRENT_TIMESTAMP()),'-01') 
		AND 
		DATEADD(dd, -DAY(DATEADD(m,1,CURRENT_TIMESTAMP() )), DATEADD(m,1,CURRENT_TIMESTAMP() ));

UPDATE EV_HORASSERVICIO 
SET SEMESTRE = SELECT SUM(DATEDIFF('MI', CREADO, ACTUALIZADO)) 
	FROM E_PRESTAMOS 
	WHERE EV_HORASSERVICIO.ID_VIDEOPROYECTOR = E_PRESTAMOS .ID_VIDEOPROYECTOR 
	AND CASE WHEN EXTRACT(MONTH FROM CREADO) < 7 
                  THEN 
                            (CREADO BETWEEN CONCAT(EXTRACT(YEAR FROM CURRENT_TIMESTAMP()),'-01-01') 
                            AND 
                            CONCAT(EXTRACT(YEAR FROM CURRENT_TIMESTAMP()),'-06-30')) 
                  ELSE 
                            (CREADO BETWEEN CONCAT(EXTRACT(YEAR FROM CURRENT_TIMESTAMP()),'-07-01') 
                            AND 
                            CONCAT(EXTRACT(YEAR FROM CURRENT_TIMESTAMP()),'-12-31')) 
	END;
*/
ALTER TABLE E_PRESTAMOS DROP CONSTRAINT PRESTAMOS_FK_USUARIO_REGISTRA_SALIDA;
ALTER TABLE E_PRESTAMOS DROP CONSTRAINT PRESTAMOS_FK_USUARIO_REGISTRA_ENTRADA;
ALTER TABLE E_PRESTAMOS DROP CONSTRAINT PRESTAMOS_FK_PROFESOR;
ALTER TABLE E_PRESTAMOS DROP CONSTRAINT PRESTAMOS_FK_AULA;
ALTER TABLE E_PRESTAMOS DROP CONSTRAINT PRESTAMOS_FK_VIDEOPROYECTOR;
ALTER TABLE EV_HORASSERVICIO DROP CONSTRAINT HORASSERVICIO_FK_VIDEOPROYECTOR;
ALTER TABLE EVR_AVERIAS DROP CONSTRAINT AVERIAS_FK_VIDEOPROYECTOR;
ALTER TABLE EVR_AVERIAS DROP CONSTRAINT AVERIAS_FK_REPORTE;

ALTER TABLE E_PRESTAMOS
ADD CONSTRAINT PRESTAMOS_FK_USUARIO_REGISTRA_SALIDA
FOREIGN KEY (ID_SALIDA) REFERENCES E_USUARIOS(ID_USUARIO)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE E_PRESTAMOS
ADD CONSTRAINT PRESTAMOS_FK_USUARIO_REGISTRA_ENTRADA
FOREIGN KEY (ID_ENTRADA) REFERENCES E_USUARIOS(ID_USUARIO)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE E_PRESTAMOS
ADD CONSTRAINT PRESTAMOS_FK_PROFESOR
FOREIGN KEY (ID_PROFESOR)
REFERENCES E_PROFESORES(ID_PROFESOR)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE E_PRESTAMOS
ADD CONSTRAINT PRESTAMOS_FK_AULA
FOREIGN KEY (ID_AULA)
REFERENCES E_AULAS(ID_AULA)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE E_PRESTAMOS
ADD CONSTRAINT PRESTAMOS_FK_VIDEOPROYECTOR
FOREIGN KEY (ID_VIDEOPROYECTOR)
REFERENCES E_VIDEOPROYECTORES(ID_VIDEOPROYECTOR)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE EV_HORASSERVICIO
ADD CONSTRAINT HORASSERVICIO_FK_VIDEOPROYECTOR
FOREIGN KEY (ID_VIDEOPROYECTOR)
REFERENCES E_VIDEOPROYECTORES(ID_VIDEOPROYECTOR)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE EVR_AVERIAS
ADD CONSTRAINT AVERIAS_FK_VIDEOPROYECTOR
FOREIGN KEY (ID_VIDEOPROYECTOR)
REFERENCES E_VIDEOPROYECTORES(ID_VIDEOPROYECTOR)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE EVR_AVERIAS
ADD CONSTRAINT AVERIAS_FK_REPORTE
FOREIGN KEY (ID_REPORTE)
REFERENCES EVR_REPORTES(ID_REPORTE)
ON DELETE CASCADE
ON UPDATE CASCADE;